<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard - Attendify</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .search-container {
      margin-bottom: 20px;
      padding: 15px;
      background: #fff2e5;
      border-radius: 8px;
      border: 2px solid #fca339;
    }
    
    .search-container h3 {
      margin: 0 0 10px 0;
      color: #312e2e;
      font-size: 16px;
    }
    
    #dateSearch {
      width: 100%;
      max-width: 300px;
      padding: 12px 15px;
      border: 2px solid #fca339;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #312e2e;
    }
    
    #dateSearch:focus {
      outline: none;
      border-color: #f03f3f;
    }
    
    #searchClear {
      padding: 12px 20px;
      background: linear-gradient(135deg, #fca339 0%, #f03f3f 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: transform 0.2s;
    }
    
    #searchClear:hover {
      transform: translateY(-2px);
    }
    
    #formError {
      padding: 12px 15px;
      border-radius: 6px;
      background: #f8f9fa;
      border-left: 4px solid #dc3545;
      margin-bottom: 15px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .no-results {
      text-align: center;
      color: #6e6966;
      padding: 30px;
      font-style: italic;
    }

    .content-section, .stats-grid {
      display: none;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Attendify</h2>
        <p>Student Portal</p>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item active-nav" href="#" id="dashboardNav">Dashboard</a>
        <a class="nav-item" href="#" id="applyLeaveBtn">Apply Leave</a>
        <a class="nav-item" href="#" id="analyticsNav">üìä Analytics</a>
        <a class="nav-item logout" href="login.html" id="logoutBtn">Logout</a>
      </nav>
    </aside>

    <main class="main-content">
      <header class="dashboard-header" style="position: relative;">
        <h1 id="welcomeMessage">Welcome, Student</h1>
        <div class="user-profile" style="position: relative; cursor: pointer;">
          <span id="profileName">Student Profile</span>
          <div class="profile-icon" id="profileIcon">S</div>
          <div id="profileDropdown" class="profile-dropdown" style="display: none;">
            <form id="profileForm">
              <h3>Profile Information</h3>
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" name="fullName" required />
              <label for="studentId">Student ID</label>
              <input type="text" id="studentId" name="studentId" disabled />
              <label for="department">Department</label>
              <input type="text" id="department" name="department" disabled />
              <label for="year">Year</label>
              <input type="number" id="year" name="year" disabled />
              <button type="submit">Update Profile</button>
            </form>
            <hr />
            <form id="changePasswordForm">
              <h3>Change Password</h3>
              <label for="currentPassword">Current Password</label>
              <input type="password" id="currentPassword" name="currentPassword" required />
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" name="newPassword" required />
              <label for="confirmPassword">Confirm New Password</label>
              <input type="password" id="confirmPassword" name="confirmPassword" required />
              <button type="submit">Change Password</button>
            </form>
          </div>
        </div>
      </header>

      <div class="stats-grid" id="dashboardStatsSection">
        <div class="stat-card">
          <h3>Total Applications</h3>
          <p class="stat-number" id="totalApplications">0</p>
        </div>
        <div class="stat-card approved">
          <h3>Approved</h3>
          <p class="stat-number" id="approvedApplications">0</p>
        </div>
        <div class="stat-card pending">
          <h3>Pending</h3>
          <p class="stat-number" id="pendingApplications">0</p>
        </div>
        <div class="stat-card rejected">
          <h3>Rejected</h3>
          <p class="stat-number" id="rejectedApplications">0</p>
        </div>
      </div>

      <div class="content-section" id="dashboardSection">
        <h2>My Applications</h2>
        
        <div class="search-container">
          <h3>üîç Search by Date</h3>
          <input type="date" id="dateSearch" placeholder="Select date to search..." />
          <button id="searchClear" style="display: none;">Clear Search</button>
        </div>
        
        <table class="applications-table">
          <thead>
            <tr>
              <th>Application Number</th>
              <th>Leave Type</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="applicationsTableBody">
          </tbody>
        </table>
      </div>

      <div class="content-section" id="applyLeaveSection">
        <h2>Apply for Leave</h2>
        <form class="leave-form" id="leaveForm">
          <div id="formError" style="display: none;"></div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="departmentSelect">Department</label>
              <select id="departmentSelect" required>
                <option value="">Select Department</option>
                <option value="cse">Computer Science Engineering</option>
                <option value="ece">Electronics Engineering</option>
                <option value="mech">Mechanical Engineering</option>
                <option value="civil">Civil Engineering</option>
                <option value="eee">Electrical Engineering</option>
              </select>
            </div>
            <div class="form-group">
              <label for="yearSelect">Year of Student</label>
              <select id="yearSelect" required>
                <option value="">Select Year</option>
                <option value="1">1st Year</option>
                <option value="2">2nd Year</option>
                <option value="3">3rd Year</option>
                <option value="4">4th Year</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="rollNumber">Roll Number</label>
              <input type="text" id="rollNumber" placeholder="Enter your roll number" required />
            </div>
            <div class="form-group">
              <label for="leaveType">Leave Type</label>
              <select id="leaveType" required>
                <option value="">Select Leave Type</option>
                <option value="sick">Sick Leave</option>
                <option value="casual">Casual Leave</option>
                <option value="emergency">Emergency Leave</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="startDate">Start Date</label>
              <input type="date" id="startDate" required />
            </div>
            <div class="form-group">
              <label for="endDate">End Date</label>
              <input type="date" id="endDate" required />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="document">Upload Document</label>
              <input type="file" id="document" />
            </div>
          </div>
          
          <div class="form-group">
            <label for="reason">Reason</label>
            <textarea id="reason" rows="4" placeholder="Enter reason for leave" required></textarea>
          </div>
          
          <button type="submit" class="submit-btn">Submit Application</button>
        </form>
      </div>

      <div class="content-section" id="analyticsSection">
        <h2>üìä Leave Analytics</h2>
        
        <div class="stats-grid" style="display: grid; margin-bottom: 30px;">
          <div class="stat-card approved">
            <h3>This Month</h3>
            <p class="stat-number" id="monthTotal">0</p>
          </div>
          <div class="stat-card pending">
            <h3>Last Month</h3>
            <p class="stat-number" id="lastMonthTotal">0</p>
          </div>
          <div class="stat-card">
            <h3>Average Duration</h3>
            <p class="stat-number" id="avgDuration">0 days</p>
          </div>
          <div class="stat-card rejected">
            <h3>Approval Rate</h3>
            <p class="stat-number" id="approvalRate">0%</p>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          <div style="background: #fff2e5; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px #f9d3c5aa;">
            <h3 style="margin-bottom: 15px; color: #312e2e;">Leave Types Breakdown</h3>
            <div id="leaveTypeChart" style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: #6e6966;">
              Loading data...
            </div>
          </div>
          <div style="background: #fff2e5; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px #f9d3c5aa;">
            <h3 style="margin-bottom: 15px; color: #312e2e;">Status Distribution</h3>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 30px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="status-badge approved" style="flex: 1; text-align: center; padding: 10px;">Approved</span>
                <span style="font-size: 24px; font-weight: bold; margin-left: 15px; color: #312e2e;" id="statusApproved">0</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="status-badge pending" style="flex: 1; text-align: center; padding: 10px;">Pending</span>
                <span style="font-size: 24px; font-weight: bold; margin-left: 15px; color: #312e2e;" id="statusPending">0</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="status-badge rejected" style="flex: 1; text-align: center; padding: 10px;">Rejected</span>
                <span style="font-size: 24px; font-weight: bold; margin-left: 15px; color: #312e2e;" id="statusRejected">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const dashboardNav = document.getElementById('dashboardNav');
    const applyLeaveBtn = document.getElementById('applyLeaveBtn');
    const analyticsNav = document.getElementById('analyticsNav');
    const logoutBtn = document.getElementById('logoutBtn');

    const dashboardStatsSection = document.getElementById('dashboardStatsSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const applyLeaveSection = document.getElementById('applyLeaveSection');
    const analyticsSection = document.getElementById('analyticsSection');

    function hideAllSections() {
      dashboardStatsSection.style.display = 'none';
      dashboardSection.style.display = 'none';
      applyLeaveSection.style.display = 'none';
      analyticsSection.style.display = 'none';
    }

    function setActiveNav(activeItem) {
      document.querySelectorAll('.sidebar-nav .nav-item').forEach(nav => {
        nav.classList.remove('active-nav');
      });
      activeItem.classList.add('active-nav');
    }

    dashboardNav.addEventListener('click', e => {
      e.preventDefault();
      hideAllSections();
      dashboardStatsSection.style.display = 'grid';
      dashboardSection.style.display = 'block';
      setActiveNav(dashboardNav);
    });

    applyLeaveBtn.addEventListener('click', e => {
      e.preventDefault();
      hideAllSections();
      applyLeaveSection.style.display = 'block';
      setActiveNav(applyLeaveBtn);
    });

    analyticsNav.addEventListener('click', e => {
      e.preventDefault();
      hideAllSections();
      analyticsSection.style.display = 'block';
      loadAnalytics();
      setActiveNav(analyticsNav);
    });

    const profileIcon = document.getElementById('profileIcon');
    const profileDropdown = document.getElementById('profileDropdown');
    const profileForm = document.getElementById('profileForm');
    const changePasswordForm = document.getElementById('changePasswordForm');

    profileIcon.addEventListener('click', () => {
      if (profileDropdown.style.display === 'none' || profileDropdown.style.display === '') {
        profileDropdown.style.display = 'block';
        profileForm.fullName.value = localStorage.getItem('userName') || 'Student Name';
        profileForm.studentId.value = localStorage.getItem('userId') || 'STU001';
        profileForm.department.value = localStorage.getItem('department') || 'CSE';
        profileForm.year.value = localStorage.getItem('year') || '3';
      } else {
        profileDropdown.style.display = 'none';
      }
    });

    profileForm.addEventListener('submit', e => {
      e.preventDefault();
      const newName = profileForm.fullName.value;
      localStorage.setItem('userName', newName);
      
      document.getElementById('welcomeMessage').textContent = 'Welcome, ' + newName;
      document.getElementById('profileName').textContent = newName;
      document.getElementById('profileIcon').textContent = newName.charAt(0).toUpperCase();
      
      alert('Profile updated successfully!');
      profileDropdown.style.display = 'none';
    });

    changePasswordForm.addEventListener('submit', e => {
      e.preventDefault();
      const newPass = changePasswordForm.newPassword.value;
      const confirmPass = changePasswordForm.confirmPassword.value;
      if (newPass !== confirmPass) {
        alert('New passwords do not match!');
        return;
      }
      alert('Password changed successfully!');
      changePasswordForm.reset();
      profileDropdown.style.display = 'none';
    });

    const userName = localStorage.getItem('userName') || 'Student Name';
    document.getElementById('welcomeMessage').textContent = 'Welcome, ' + userName;
    document.getElementById('profileName').textContent = userName;
    document.getElementById('profileIcon').textContent = userName.charAt(0).toUpperCase();

    logoutBtn.addEventListener('click', e => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    let allStudentApplications = [];

    function initializeStudentApplications() {
      allStudentApplications = JSON.parse(localStorage.getItem('studentApplications') || '[]');
      
      if (allStudentApplications.length === 0) {
        const defaultApps = [
          {id: '#LA001', leaveType: 'Sick Leave', startDate: '2025-11-10', endDate: '2025-11-12', status: 'pending'},
          {id: '#LA002', leaveType: 'Casual Leave', startDate: '2025-11-01', endDate: '2025-11-02', status: 'approved'},
          {id: '#LA003', leaveType: 'Emergency Leave', startDate: '2025-10-25', endDate: '2025-10-26', status: 'rejected'}
        ];
        allStudentApplications = defaultApps;
        localStorage.setItem('studentApplications', JSON.stringify(defaultApps));
      }
      
      loadApplicationsTable('');
      updateStats();
    }

    function loadApplicationsTable(searchDate) {
      const tableBody = document.getElementById('applicationsTableBody');
      tableBody.innerHTML = '';
      
      let filteredApps = allStudentApplications;
      
      if (searchDate) {
        filteredApps = allStudentApplications.filter(app => 
          app.startDate === searchDate || app.endDate === searchDate
        );
      }
      
      const displayApps = filteredApps.slice(-10).reverse();
      
      if (displayApps.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="no-results">No applications found</td></tr>';
        return;
      }
      
      displayApps.forEach(app => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${app.id}</td>
          <td>${app.leaveType}</td>
          <td>${app.startDate}</td>
          <td>${app.endDate}</td>
          <td><span class="status-badge ${app.status}">${app.status.charAt(0).toUpperCase() + app.status.slice(1)}</span></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function updateStats() {
      document.getElementById('totalApplications').textContent = allStudentApplications.length;
      document.getElementById('approvedApplications').textContent = allStudentApplications.filter(a => a.status === 'approved').length;
      document.getElementById('pendingApplications').textContent = allStudentApplications.filter(a => a.status === 'pending').length;
      document.getElementById('rejectedApplications').textContent = allStudentApplications.filter(a => a.status === 'rejected').length;
    }

    const leaveForm = document.getElementById('leaveForm');
    const submitBtn = leaveForm.querySelector('button[type="submit"]');
    const formError = document.getElementById('formError');

    leaveForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const formData = {
        id: #LA${String(allStudentApplications.length + 1).padStart(3, '0')},
        leaveType: document.getElementById('leaveType').options[document.getElementById('leaveType').selectedIndex].text,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        status: 'pending',
        rollNumber: document.getElementById('rollNumber').value,
        department: document.getElementById('departmentSelect').options[document.getElementById('departmentSelect').selectedIndex].text,
        year: document.getElementById('yearSelect').options[document.getElementById('yearSelect').selectedIndex].text,
        reason: document.getElementById('reason').value
      };
      
      const startDate = new Date(formData.startDate);
      const endDate = new Date(formData.endDate);
      
      if (startDate > endDate) {
        formError.textContent = '‚ùå Start date must be before or same as end date';
        formError.style.borderLeftColor = '#dc3545';
        formError.style.display = 'block';
        return;
      }
      
      formError.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      setTimeout(() => {
        allStudentApplications.push(formData);
        localStorage.setItem('studentApplications', JSON.stringify(allStudentApplications));
        
        leaveForm.reset();
        
        loadApplicationsTable(document.getElementById('dateSearch').value);
        updateStats();
        
        formError.textContent = '‚úÖ Leave application submitted successfully!';
        formError.style.borderLeftColor = '#28a745';
        formError.style.display = 'block';
        
        setTimeout(() => {
          formError.style.display = 'none';
          hideAllSections();
          dashboardStatsSection.style.display = 'grid';
          dashboardSection.style.display = 'block';
          setActiveNav(dashboardNav);
        }, 2000);
        
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
        
      }, 1500);
    });

    const dateSearch = document.getElementById('dateSearch');
    const searchClear = document.getElementById('searchClear');

    dateSearch.addEventListener('change', () => {
      loadApplicationsTable(dateSearch.value);
      searchClear.style.display = dateSearch.value ? 'block' : 'none';
    });

    searchClear.addEventListener('click', () => {
      dateSearch.value = '';
      loadApplicationsTable('');
      searchClear.style.display = 'none';
    });

    function loadAnalytics() {
      const apps = allStudentApplications;
      
      if (apps.length === 0) {
        document.getElementById('leaveTypeChart').innerHTML = '<div style="text-align: center; color: #6e6966;">No data available yet</div>';
        return;
      }
      
      const now = new Date();
      const thisMonth = apps.filter(app => {
        const appDate = new Date(app.startDate);
        return appDate.getMonth() === now.getMonth() && appDate.getFullYear() === now.getFullYear();
      });
      document.getElementById('monthTotal').textContent = thisMonth.length;
      
      const lastMonth = apps.filter(app => {
        const appDate = new Date(app.startDate);
        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);
        return appDate.getMonth() === lastMonthDate.getMonth() && appDate.getFullYear() === lastMonthDate.getFullYear();
      });
      document.getElementById('lastMonthTotal').textContent = lastMonth.length;
      
      let totalDays = 0;
      apps.forEach(app => {
        const start = new Date(app.startDate);
        const end = new Date(app.endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        totalDays += days;
      });
      const avgDays = apps.length > 0 ? (totalDays / apps.length).toFixed(1) : 0;
      document.getElementById('avgDuration').textContent = avgDays + ' days';
      
      const approved = apps.filter(a => a.status === 'approved').length;
      const rate = apps.length > 0 ? Math.round((approved / apps.length) * 100) : 0;
      document.getElementById('approvalRate').textContent = rate + '%';
      
      document.getElementById('statusApproved').textContent = approved;
      document.getElementById('statusPending').textContent = apps.filter(a => a.status === 'pending').length;
      document.getElementById('statusRejected').textContent = apps.filter(a => a.status === 'rejected').length;
      
      const leaveTypes = {};
      apps.forEach(app => {
        leaveTypes[app.leaveType] = (leaveTypes[app.leaveType] || 0) + 1;
      });
      
      let chartHTML = '<div style="text-align: center; padding: 20px;">';
      chartHTML += '<div style="font-size: 36px; font-weight: bold; color: #312e2e; margin-bottom: 10px;">' + apps.length + '</div>';
      chartHTML += '<div style="font-size: 14px; color: #6e6966; margin-bottom: 20px;">Total Leave Applications</div>';
      chartHTML += '<div style="margin-top: 20px;">';
      
      Object.entries(leaveTypes).forEach(([type, count]) => {
        const percentage = Math.round((count / apps.length) * 100);
        chartHTML += `
          <div style="margin: 10px 0; text-align: left;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="font-size: 14px; color: #312e2e; font-weight: 500;">${type}</span>
              <span style="font-size: 14px; color: #6e6966;">${count} (${percentage}%)</span>
            </div>
            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background: linear-gradient(135deg, #fca339 0%, #f03f3f 100%); width: ${percentage}%; height: 100%;"></div>
            </div>
          </div>
        `;
      });
      
      chartHTML += '</div></div>';
      document.getElementById('leaveTypeChart').innerHTML = chartHTML;
    }

    initializeStudentApplications();
    dashboardStatsSection.style.display = 'grid';
    dashboardSection.style.display = 'block';
  </script>
</body>
</html>
